{% extends 'base.html' %}

{% block content %}
<script>
  function submitForm(recordId) {
    document.getElementById("recordId_" + recordId).value = recordId;
    document.getElementById("myForm_" + recordId).submit();
  }
</script>
<style>
  #dt-search-0 {
    width: 300px;
  }
</style>
<!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<div class="container mt-4">
  <h1 class="text-center">Depot 2025 Table</h1>
  {% if schemes %}
  <table id="depot25" class="table" width="100%" style="text-align: center;">
    <thead class="table-info sticky-top" style="text-align: center;">
      <tr>
        <th>Area Engineer</th>
        <th>Scheme Reference</th>
        <th>Planning Status</th>
        <th>Passed Date</th>
        <th>Block Number</th>
        <th>Substation Number</th>
        <th>Transformer Number</th>
        <th>Feeder Number</th>
        <th>LVB Number</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for scheme in schemes %}
      <tr>
        <td>{{ scheme.AREA_ENGINEER_NAME }}</td>
        <td>{{ scheme.REFRENCENUMBER }}</td>
        <td>
          <span style="font-size: 12px;"
            class="{% if scheme.PlanStatus == 'Completed' %}badge badge-success rounded-pill d-inline{% elif scheme.PlanStatus == 'In GIS' %}badge badge-primary rounded-pill d-inline{% elif scheme.PlanStatus == 'In Wayleave' %}badge badge-warning rounded-pill d-inline{% elif scheme.PlanStatus == 'Not Required' %}badge badge-info rounded-pill d-inline{% elif scheme.PlanStatus == 'In Design' %}badge badge-danger rounded-pill d-inline{% endif %}">
            {{ scheme.PlanStatus }}
          </span>
        </td>
        <td>{{ scheme.PASSEDDATE }}</td>
        <td>{{ scheme.BLOCKNUMBER }}</td>
        <td>{{ scheme.SUBSTATIONNUMBER }}</td>
        <td>{{ scheme.TX }}</td>
        <td>{{ scheme.FEEDERNUMBER }}</td>
        <td>{{ scheme.LVBNUMBER }}</td>
        <td style="width: 230px;">
          <a href="#"><i class="fas fa-eye"
              style="text-decoration: none; color: #679ef2; padding: 10px; display: inline-block; font-size: 20px;"></i></a>
          <i class="fas fa-edit" data-toggle="modal" data-target="#updateModal" data-id="{{ scheme.id }}"
            style="text-decoration: none;font-size: 20px; color: #f4c767; padding: 10px; display: inline-block;"></i>
          {% if is_admin %}
          <form id="myForm_{{ scheme.id }}" action="{% url 'delete_depot25' scheme.id %}" method="POST"
            style="display:inline;">
            {% csrf_token %}
            <input type="hidden" id="recordId_{{ scheme.id }}" name="recordId" value="{{ scheme.id }}">
            <a href="javascript:void(0);" onclick="submitForm('{{ scheme.id }}')"><i class="fas fa-trash"
                style="text-decoration: none;font-size: 20px; color: #f88498; padding: 10px; display: inline-block;"></i></a>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <h1 style="text-align: center; margin-top: 100px;">No Data Available</h1>
  {% endif %}

  <!-- Modal -->
  <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel">Update Depot Case</h5>
        </div>
        <div class="modal-body">
          <form id="updateForm">
            {% csrf_token %}
            <input type="hidden" name="id" id="caseId">

            <!-- Form Fields -->
            <div class="form-group">
              <label for="REFRENCENUMBER">Reference Number</label>
              <input type="text" class="form-control" id="REFRENCENUMBER" name="REFRENCENUMBER" required>
            </div>

            <div class="form-group">
              <label for="DEPOT">Depot</label>
              <input type="text" class="form-control" id="DEPOT" name="DEPOT">
            </div>

            <div class="form-group">
              <label for="AREA_ENGINEER_NAME">Area Engineer Name</label>
              <input type="text" class="form-control" id="AREA_ENGINEER_NAME" name="AREA_ENGINEER_NAME">
            </div>

            <div class="form-group">
              <label for="BLOCKNUMBER">Block Number</label>
              <input type="text" class="form-control" id="BLOCKNUMBER" name="BLOCKNUMBER">
            </div>

            <div class="form-group">
              <label for="SUBSTATIONNUMBER">Substation Number</label>
              <input type="text" class="form-control" id="SUBSTATIONNUMBER" name="SUBSTATIONNUMBER">
            </div>

            <div class="form-group">
              <label for="TX">TX</label>
              <input type="text" class="form-control" id="TX" name="TX">
            </div>

            <div class="form-group">
              <label for="FEEDERNUMBER">Feeder Number</label>
              <input type="text" class="form-control" id="FEEDERNUMBER" name="FEEDERNUMBER">
            </div>

            <div class="form-group">
              <label for="LVBNUMBER">LVB Number</label>
              <input type="text" class="form-control" id="LVBNUMBER" name="LVBNUMBER">
            </div>

            <div class="form-group">
              <label for="TYPE">Type</label>
              <input type="text" class="form-control" id="TYPE" name="TYPE">
            </div>

            <div class="form-group">
              <label for="WAYLEAVENUMBER">Way Leave Number</label>
              <input type="text" class="form-control" id="WAYLEAVENUMBER" name="WAYLEAVENUMBER">
            </div>

            <!-- Date Fields with Flatpickr -->
            <div class="form-group">
              <label for="USPDATE">USP Date</label>
              <input type="text" class="form-control flatpickr" id="USPDATE" name="USPDATE">
            </div>

            <div class="form-group">
              <label for="PASSEDDATE">Passed Date</label>
              <input type="text" class="form-control flatpickr" id="PASSEDDATE" name="PASSEDDATE">
            </div>

            <div class="form-group">
              <label for="GISDATE">GIS Date</label>
              <input type="text" class="form-control flatpickr" id="GISDATE" name="GISDATE">
            </div>

            <div class="form-group">
              <label for="RCCDATE">RCC Date</label>
              <input type="text" class="form-control flatpickr" id="RCCDATE" name="RCCDATE">
            </div>

            <div class="form-group">
              <label for="MSPDATE">MSP Date</label>
              <input type="text" class="form-control flatpickr" id="MSPDATE" name="MSPDATE">
            </div>

            <div class="form-group">
              <label for="sentDate">Sent Date</label>
              <input type="text" class="form-control flatpickr" id="sentDate" name="sentDate">
            </div>

            <!-- Other Fields -->
            <div class="form-group">
              <label for="REMARKES">Remarks</label>
              <textarea class="form-control" id="REMARKES" name="REMARKES"></textarea>
            </div>

            <div class="form-group">
              <label for="PlanStatus">Plan Status</label>
              <input type="text" class="form-control" id="PlanStatus" name="PlanStatus">
            </div>

            <div class="form-group">
              <label for="ConStatus">Construction Status</label>
              <input type="text" class="form-control" id="ConStatus" name="ConStatus">
            </div>

            <div class="form-group">
              <label for="labourcost">Labour Cost</label>
              <input type="number" class="form-control" id="labourcost" name="labourcost">
            </div>

            <div class="form-group">
              <label for="ministrycost">Ministry Cost</label>
              <input type="number" class="form-control" id="ministrycost" name="ministrycost">
            </div>

            <div class="form-group">
              <label for="cable_length">Cable Length</label>
              <input type="number" class="form-control" id="cable_length" name="cable_length">
            </div>

            <div class="form-group">
              <label for="Area">Area</label>
              <input type="text" class="form-control" id="Area" name="Area">
            </div>

            <div class="form-group">
              <label for="gov">Gov</label>
              <input type="text" class="form-control" id="gov" name="gov">
            </div>

            <div class="form-group">
              <label for="noOfServ">Number of Services</label>
              <input type="number" class="form-control" id="noOfServ" name="noOfServ">
            </div>

            <div class="form-group">
              <label for="noOfFaults">Number of Faults</label>
              <input type="number" class="form-control" id="noOfFaults" name="noOfFaults">
            </div>

            <div class="form-group">
              <label for="areaEngEmail">Area Engineer Email</label>
              <input type="email" class="form-control" id="areaEngEmail" name="areaEngEmail">
            </div>

            <div class="form-group">
              <label for="EngPhoneNumber">Engineer Phone Number</label>
              <input type="text" class="form-control" id="EngPhoneNumber" name="EngPhoneNumber">
            </div>

            <div class="form-group">
              <label for="AreaOfAe">Area of Area Engineer</label>
              <input type="text" class="form-control" id="AreaOfAe" name="AreaOfAe">
            </div>

            <div class="form-group">
              <label for="totalcost">Total Cost</label>
              <input type="number" class="form-control" id="totalcost" name="totalcost">
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>




  <script>
    $(document).ready(function () {
      // Attach the show event for the modal
      $('#updateModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        console.log(event.relatedTarget)// Button that triggered the modal
        var caseId = button.data('id'); // Extract info from data-* attributes
        if (!caseId) {
          console.error("Invalid or missing case ID.");
          return;
        }
        // Fetch case data using AJAX
        $.get('/update/' + caseId + '/', function (data) {
          $('#caseId').val(data.id);
          $('#REFRENCENUMBER').val(data.REFRENCENUMBER);
          $('#DEPOT').val(data.DEPOT);
          $('#AREA_ENGINEER_NAME').val(data.AREA_ENGINEER_NAME);
          $('#BLOCKNUMBER').val(data.BLOCKNUMBER);
          $('#SUBSTATIONNUMBER').val(data.SUBSTATIONNUMBER);
          $('#TX').val(data.TX);
          $('#FEEDERNUMBER').val(data.FEEDERNUMBER);
          $('#LVBNUMBER').val(data.LVBNUMBER);
          $('#TYPE').val(data.TYPE);
          $('#WAYLEAVENUMBER').val(data.WAYLEAVENUMBER);
          $('#USPDATE').val(data.USPDATE);
          $('#PASSEDDATE').val(data.PASSEDDATE);
          $('#REMARKES').val(data.REMARKES);
          $('#PlanStatus').val(data.PlanStatus);
          $('#ConStatus').val(data.ConStatus);
          $('#GISDATE').val(data.GISDATE);
          $('#RCCDATE').val(data.RCCDATE);
          $('#MSPDATE').val(data.MSPDATE);
          $('#labourcost').val(data.labourcost);
          $('#ministrycost').val(data.ministrycost);
          $('#cable_length').val(data.cable_length);
          $('#Area').val(data.Area);
          $('#gov').val(data.gov);
          $('#sentDate').val(data.sentDate);
          $('#noOfServ').val(data.noOfServ);
          $('#noOfFaults').val(data.noOfFaults);
          $('#areaEngEmail').val(data.areaEngEmail);
          $('#EngPhoneNumber').val(data.EngPhoneNumber);
          $('#AreaOfAe').val(data.AreaOfAe);
          $('#totalcost').val(data.totalcost);
        });
        $("#depot24-form").on("submit", function (event) {
          event.preventDefault(); // Prevent default form submission behavior
          // Add your AJAX code here to submit the form data
          function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
                }
              }
            }
            return cookieValue;
          }

          const csrftoken = getCookie('csrftoken');


          $.ajax({
            type: "POST",
            url: '/update/' + caseId + '/',
            data: $(this).serialize(),
            headers: {
              "X-CSRFToken": csrftoken
            },
            success: function (response) {
              if (response.success) {
                location.reload();
              }
            },
            error: function (error) {
              console.log("Error:", error);
            }
          });
        });
        // Handle form submission
        $('#updateForm').off('submit').on('submit', function (e) {
          e.preventDefault();
          $.ajax({
            type: "POST",
            url: '/update/' + caseId + '/',
            data: $(this).serialize(),
            success: function (response) {
              if (response.success) {
                location.reload(); // Refresh page
              }
            },
            error: function (error) {
              console.log("Error:", error);
            }
          });
        });
      });
    });
  </script>
  <script>
    $(document).ready(function () {
      var table = $('#depot25').DataTable({
        autoFill: true
      });

    })
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      flatpickr(".flatpickr", {
        dateFormat: "Y-m-d", // Set the format to yyyy-MM-dd
      });
    });
  </script>
  {% endblock %}